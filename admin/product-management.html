<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý sản phẩm - Admin Panel</title>
    <link rel="stylesheet" href="./assets/css/admin-style.css" />
    <link rel="stylesheet" href="../client/assets/css/font.css" />
    <link rel="icon" type="image/png" href="../client/assets/images/Logo.png" />
    <link rel="stylesheet" href="./assets/css/font.css" />
  </head>
  <body>
    <!-- Admin Header -->
    <header class="admin-header">
      <div class="container">
        <div class="admin-logo">
          <img src="../client/assets/images/Logo.png" alt="Logo" />
          <span>Admin Panel</span>
        </div>
        <div class="admin-user-info">
          <div class="user-avatar">A</div>
          <span>Admin User</span>
          <button class="logout-btn" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            Đăng xuất
          </button>
        </div>
      </div>
    </header>

    <!-- Admin Layout -->
    <div class="admin-layout">
      <!-- Sidebar -->
      <nav class="admin-sidebar">
        <!-- Logo -->
        <div class="sidebar-logo">
          <div class="logo-text">
            <div class="logo-icon">
              <i class="fas fa-chart-bar"></i>
            </div>
            <span>AdminPanel</span>
          </div>
        </div>

        <!-- Menu -->
        <ul class="sidebar-menu">
          <div class="menu-section-title">Menu</div>
          <li>
            <a href="dashboard.html">
              <i class="fas fa-tachometer-alt"></i>
              Dashboard
            </a>
          </li>
          <li>
            <a href="user-management.html">
              <i class="fas fa-users"></i>
              Quản lý khách hàng
            </a>
          </li>
          <li>
            <a href="product-type-management.html">
              <i class="fas fa-tags"></i>
              Quản lý loại sản phẩm
            </a>
          </li>
          <li>
            <a href="product-management.html" class="active">
              <i class="fas fa-box"></i>
              Quản lý sản phẩm
            </a>
          </li>
          <li>
            <a href="import-management.html">
              <i class="fas fa-warehouse"></i>
              Quản lý nhập hàng
            </a>
          </li>
          <li>
            <a href="price-management.html">
              <i class="fas fa-dollar-sign"></i>
              Quản lý giá bán
            </a>
          </li>
          <li>
            <a href="order-management.html">
              <i class="fas fa-shopping-cart"></i>
              Quản lý đơn hàng
            </a>
          </li>
          <li>
            <a href="inventory-management.html">
              <i class="fas fa-clipboard-list"></i>
              Quản lý tồn kho
            </a>
          </li>
          <li>
            <a href="#" onclick="handleLogout(); return false;">
              <i class="fas fa-sign-out-alt"></i>
              Đăng xuất
            </a>
          </li>
        </ul>
      </nav>

      <!-- Mobile Menu Toggle -->
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>

      <!-- Main Content -->
      <main class="admin-main">
        <div class="admin-content">
          <!-- Page Header -->
          <div class="page-header">
            <h1 class="page-title">Quản lý sản phẩm</h1>
            <p class="page-subtitle">
              Thêm, sửa, xóa và ẩn/hiện các sản phẩm trong cửa hàng
            </p>
          </div>

          <!-- Search and Filter Bar -->
          <div class="search-filter-bar">
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input
                type="text"
                placeholder="Tìm kiếm sản phẩm theo tên, mã sản phẩm..."
              />
            </div>
            <select class="form-control filter-select">
              <option value="all">Tất cả loại sản phẩm</option>
              <option value="LSP001">Thuốc cảm cúm</option>
              <option value="LSP002">Vitamin và thực phẩm chức năng</option>
              <option value="LSP003">Thuốc giảm đau</option>
              <option value="LSP004">Thuốc ho</option>
              <option value="LSP005">Thuốc tiêu hóa</option>
            </select>
            <button class="btn btn-primary" data-modal="addProductModal">
              <i class="fas fa-plus"></i>
              Thêm sản phẩm
            </button>
          </div>

          <!-- Products Table -->
          <div class="admin-card">
            <div class="card-header">
              <h3 class="card-title">Danh sách sản phẩm</h3>
              <span class="text-muted">Tổng: 1,250 sản phẩm</span>
            </div>
            <div class="table-container">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th data-sort="0">Mã SP</th>
                    <!-- <th data-sort="1">Hình ảnh</th> -->
                    <th data-sort="2">Tên sản phẩm</th>
                    <th data-sort="3">Loại sản phẩm</th>
                    <th data-sort="4">Giá bán</th>
                    <th data-sort="5">Tồn kho</th>
                    <th data-sort="6">Ngày tạo</th>
                    <th data-sort="7">Trạng thái</th>
                    <th>Thao tác</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>SP001</td>
                    <!-- <td>
                      <img
                        src="../client/assets/images/panadol.png"
                        alt="Panadol"
                        class="product-thumbnail"
                      />
                    </td> -->
                    <td>Panadol Extra 500mg</td>
                    <td>Thuốc giảm đau</td>
                    <td>25,000 VNĐ</td>
                    <td>150</td>
                    <td>01/11/2024</td>
                    <td>
                      <span class="status-badge status-active">Hiển thị</span>
                    </td>
                    <td>
                      <button
                        class="btn btn-sm btn-info"
                        onclick="viewProduct('SP001')"
                      >
                        <i class="fas fa-eye"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-warning"
                        onclick="handleEdit('SP001', 'editProductForm', '/api/products')"
                      >
                        <i class="fas fa-edit"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-danger"
                        onclick="handleStatusChange('SP001', 'active', 'sản phẩm')"
                      >
                        <i class="fas fa-eye-slash"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-danger"
                        onclick="handleDelete('SP001', 'sản phẩm')"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <tr>
                    <td>SP002</td>
                    <!-- <td>
                      <img
                        src="../client/assets/images/covid.png"
                        alt="Thuốc COVID"
                        class="product-thumbnail"
                      />
                    </td> -->
                    <td>Thuốc điều trị COVID-19</td>
                    <td>Thuốc cảm cúm</td>
                    <td>150,000 VNĐ</td>
                    <td>50</td>
                    <td>02/11/2024</td>
                    <td>
                      <span class="status-badge status-active">Hiển thị</span>
                    </td>
                    <td>
                      <button
                        class="btn btn-sm btn-info"
                        onclick="viewProduct('SP002')"
                      >
                        <i class="fas fa-eye"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-warning"
                        onclick="handleEdit('SP002', 'editProductForm', '/api/products')"
                      >
                        <i class="fas fa-edit"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-danger"
                        onclick="handleStatusChange('SP002', 'active', 'sản phẩm')"
                      >
                        <i class="fas fa-eye-slash"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-danger"
                        onclick="handleDelete('SP002', 'sản phẩm')"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <tr>
                    <td>SP003</td>
                    <!-- <td>
                      <img
                        src="../client/assets/images/biloba.png"
                        alt="Biloba"
                        class="product-thumbnail"
                      />
                    </td> -->
                    <td>Ginkgo Biloba 120mg</td>
                    <td>Vitamin và thực phẩm chức năng</td>
                    <td>180,000 VNĐ</td>
                    <td>75</td>
                    <td>03/11/2024</td>
                    <td>
                      <span class="status-badge status-active">Hiển thị</span>
                    </td>
                    <td>
                      <button
                        class="btn btn-sm btn-info"
                        onclick="viewProduct('SP003')"
                      >
                        <i class="fas fa-eye"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-warning"
                        onclick="handleEdit('SP003', 'editProductForm', '/api/products')"
                      >
                        <i class="fas fa-edit"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-danger"
                        onclick="handleStatusChange('SP003', 'active', 'sản phẩm')"
                      >
                        <i class="fas fa-eye-slash"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-danger"
                        onclick="handleDelete('SP003', 'sản phẩm')"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <tr>
                    <td>SP004</td>
                    <!-- <td>
                      <img
                        src="../client/assets/images/hevel.png"
                        alt="Hevel"
                        class="product-thumbnail"
                      />
                    </td> -->
                    <td>Hevel 500mg</td>
                    <td>Thuốc tiêu hóa</td>
                    <td>35,000 VNĐ</td>
                    <td>25</td>
                    <td>04/11/2024</td>
                    <td>
                      <span class="status-badge status-inactive">Đã ẩn</span>
                    </td>
                    <td>
                      <button
                        class="btn btn-sm btn-info"
                        onclick="viewProduct('SP004')"
                      >
                        <i class="fas fa-eye"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-warning"
                        onclick="handleEdit('SP004', 'editProductForm', '/api/products')"
                      >
                        <i class="fas fa-edit"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-success"
                        onclick="handleStatusChange('SP004', 'inactive', 'sản phẩm')"
                      >
                        <i class="fas fa-eye"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-danger"
                        onclick="handleDelete('SP004', 'sản phẩm')"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <tr>
                    <td>SP005</td>
                    <!-- <td>
                      <img
                        src="../client/assets/images/immucan.png"
                        alt="Immucan"
                        class="product-thumbnail"
                      />
                    </td> -->
                    <td>Immucan 100ml</td>
                    <td>Vitamin và thực phẩm chức năng</td>
                    <td>120,000 VNĐ</td>
                    <td>100</td>
                    <td>05/11/2024</td>
                    <td>
                      <span class="status-badge status-active">Hiển thị</span>
                    </td>
                    <td>
                      <button
                        class="btn btn-sm btn-info"
                        onclick="viewProduct('SP005')"
                      >
                        <i class="fas fa-eye"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-warning"
                        onclick="handleEdit('SP005', 'editProductForm', '/api/products')"
                      >
                        <i class="fas fa-edit"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-danger"
                        onclick="handleStatusChange('SP005', 'active', 'sản phẩm')"
                      >
                        <i class="fas fa-eye-slash"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-danger"
                        onclick="handleDelete('SP005', 'sản phẩm')"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="pagination"></div>
          </div>
        </div>
      </main>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Thêm sản phẩm mới</h3>
          <button class="close">&times;</button>
        </div>
        <form id="addProductForm">
          <div class="form-row">
            <div class="form-group">
              <label for="productCode" class="form-label">Mã sản phẩm *</label>
              <input
                type="text"
                id="productCode"
                name="productCode"
                class="form-control"
                placeholder="SP001"
                required
              />
            </div>
            <div class="form-group">
              <label for="productType" class="form-label"
                >Loại sản phẩm *</label
              >
              <select
                id="productType"
                name="productType"
                class="form-control"
                required
              >
                <option value="">Chọn loại sản phẩm</option>
                <option value="LSP001">Thuốc cảm cúm</option>
                <option value="LSP002">Vitamin và thực phẩm chức năng</option>
                <option value="LSP003">Thuốc giảm đau</option>
                <option value="LSP004">Thuốc ho</option>
                <option value="LSP005">Thuốc tiêu hóa</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="productName" class="form-label">Tên sản phẩm *</label>
            <input
              type="text"
              id="productName"
              name="productName"
              class="form-control"
              placeholder="Nhập tên sản phẩm"
              required
            />
          </div>
          <div class="form-group">
            <label for="productDescription" class="form-label"
              >Mô tả sản phẩm</label
            >
            <textarea
              id="productDescription"
              name="productDescription"
              class="form-control"
              rows="4"
              placeholder="Nhập mô tả chi tiết về sản phẩm"
            ></textarea>
          </div>
          <!-- <div class="form-group">
            <label for="productImage" class="form-label"
              >Hình ảnh sản phẩm</label
            >
            <input
              type="file"
              id="productImage"
              name="productImage"
              class="form-control"
              accept="image/*"
            />
            <small class="form-text text-muted"
              >Chọn hình ảnh cho sản phẩm (JPG, PNG, GIF)</small
            >
          </div> -->
          <div class="form-row">
            <div class="form-group">
              <label for="productPrice" class="form-label"
                >Giá bán (VNĐ) *</label
              >
              <input
                type="number"
                id="productPrice"
                name="productPrice"
                class="form-control"
                placeholder="25000"
                required
              />
            </div>
            <div class="form-group">
              <label for="productStock" class="form-label"
                >Số lượng tồn kho *</label
              >
              <input
                type="number"
                id="productStock"
                name="productStock"
                class="form-control"
                placeholder="100"
                required
              />
            </div>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                id="productStatus"
                name="productStatus"
                checked
              />
              <span class="checkmark"></span>
              Hiển thị sản phẩm này
            </label>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeModal(document.getElementById('addProductModal'))"
            >
              Hủy
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              Thêm sản phẩm
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Chỉnh sửa sản phẩm</h3>
          <button class="close">&times;</button>
        </div>
        <form id="editProductForm">
          <input type="hidden" id="editProductId" name="productId" />
          <div class="form-row">
            <div class="form-group">
              <label for="editProductCode" class="form-label"
                >Mã sản phẩm *</label
              >
              <input
                type="text"
                id="editProductCode"
                name="productCode"
                class="form-control"
                required
              />
            </div>
            <div class="form-group">
              <label for="editProductType" class="form-label"
                >Loại sản phẩm *</label
              >
              <select
                id="editProductType"
                name="productType"
                class="form-control"
                required
              >
                <option value="">Chọn loại sản phẩm</option>
                <option value="LSP001">Thuốc cảm cúm</option>
                <option value="LSP002">Vitamin và thực phẩm chức năng</option>
                <option value="LSP003">Thuốc giảm đau</option>
                <option value="LSP004">Thuốc ho</option>
                <option value="LSP005">Thuốc tiêu hóa</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="editProductName" class="form-label"
              >Tên sản phẩm *</label
            >
            <input
              type="text"
              id="editProductName"
              name="productName"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="editProductDescription" class="form-label"
              >Mô tả sản phẩm</label
            >
            <textarea
              id="editProductDescription"
              name="productDescription"
              class="form-control"
              rows="4"
            ></textarea>
          </div>
          <div class="form-group">
            <label for="editProductImage" class="form-label"
              >Hình ảnh sản phẩm</label
            >
            <input
              type="file"
              id="editProductImage"
              name="productImage"
              class="form-control"
              accept="image/*"
            />
            <small class="form-text text-muted"
              >Chọn hình ảnh mới để thay thế (để trống nếu không thay
              đổi)</small
            >
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="editProductPrice" class="form-label"
                >Giá bán (VNĐ) *</label
              >
              <input
                type="number"
                id="editProductPrice"
                name="productPrice"
                class="form-control"
                required
              />
            </div>
            <div class="form-group">
              <label for="editProductStock" class="form-label"
                >Số lượng tồn kho *</label
              >
              <input
                type="number"
                id="editProductStock"
                name="productStock"
                class="form-control"
                required
              />
            </div>
          </div>
          <div class="form-group">
            <label for="editProductStatus" class="form-label">Trạng thái</label>
            <select
              id="editProductStatus"
              name="productStatus"
              class="form-control"
            >
              <option value="active">Hiển thị</option>
              <option value="inactive">Ẩn</option>
            </select>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeModal(document.getElementById('editProductModal'))"
            >
              Hủy
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              Cập nhật
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- View Product Modal -->
    <div id="viewProductModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Chi tiết sản phẩm</h3>
          <button class="close">&times;</button>
        </div>
        <div class="product-detail">
          <div class="product-image-section">
            <img
              id="viewProductImage"
              src=""
              alt="Product Image"
              class="product-detail-image"
            />
          </div>
          <div class="product-info-section">
            <h4 id="viewProductName"></h4>
            <p class="product-code">
              Mã sản phẩm: <span id="viewProductCode"></span>
            </p>
            <p class="product-type">Loại: <span id="viewProductType"></span></p>
            <p class="product-price">
              Giá bán: <span id="viewProductPrice"></span>
            </p>
            <p class="product-stock">
              Tồn kho: <span id="viewProductStock"></span>
            </p>
            <p class="product-status">
              Trạng thái: <span id="viewProductStatus"></span>
            </p>
            <div class="product-description">
              <h5>Mô tả sản phẩm:</h5>
              <p id="viewProductDescription"></p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeModal(document.getElementById('viewProductModal'))"
          >
            Đóng
          </button>
        </div>
      </div>
    </div>

    <script src="./assets/js/admin.js"></script>
    <script>
      // Dữ liệu mock sản phẩm (có thể thay bằng dữ liệu từ API sau này)
      const productTypeMap = {
        LSP001: "Thuốc cảm cúm",
        LSP002: "Vitamin và thực phẩm chức năng",
        LSP003: "Thuốc giảm đau",
        LSP004: "Thuốc ho",
        LSP005: "Thuốc tiêu hóa",
      };

      const products = [
        {
          id: "SP001",
          name: "Panadol Extra 500mg",
          typeId: "LSP003",
          price: 25000,
          stock: 150,
          createdAt: "01/11/2024",
          status: "active",
          image: "../client/assets/images/panadol.png",
          description: "Thuốc giảm đau, hạ sốt hiệu quả.",
        },
        {
          id: "SP002",
          name: "Thuốc điều trị COVID-19",
          typeId: "LSP001",
          price: 150000,
          stock: 50,
          createdAt: "02/11/2024",
          status: "active",
          image: "../client/assets/images/covid.png",
          description: "Sử dụng theo chỉ định bác sĩ.",
        },
        {
          id: "SP003",
          name: "Ginkgo Biloba 120mg",
          typeId: "LSP002",
          price: 180000,
          stock: 75,
          createdAt: "03/11/2024",
          status: "active",
          image: "../client/assets/images/biloba.png",
          description: "Hỗ trợ tuần hoàn máu não.",
        },
        {
          id: "SP004",
          name: "Hevel 500mg",
          typeId: "LSP005",
          price: 35000,
          stock: 25,
          createdAt: "04/11/2024",
          status: "inactive",
          image: "../client/assets/images/hevel.png",
          description: "Hỗ trợ tiêu hóa.",
        },
        {
          id: "SP005",
          name: "Immucan 100ml",
          typeId: "LSP002",
          price: 120000,
          stock: 100,
          createdAt: "05/11/2024",
          status: "active",
          image: "../client/assets/images/immucan.png",
          description: "Bổ sung vitamin và khoáng chất.",
        },
      ];

      // Render bảng theo trang
      function renderProductTable() {
        const tbody = document.querySelector(".admin-table tbody");
        if (!tbody) return;

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = products.slice(start, end);

        tbody.innerHTML = pageItems
          .map((p) => {
            const typeName = productTypeMap[p.typeId] || "";
            const isActive = p.status === "active";
            const statusBadge = isActive
              ? '<span class="status-badge status-active">Hiển thị</span>'
              : '<span class="status-badge status-inactive">Đã ẩn</span>';
            const toggleBtn = isActive
              ? `<button class="btn btn-sm btn-danger" onclick="handleStatusChange('${p.id}', 'active', 'sản phẩm')"><i class=\"fas fa-eye-slash\"></i></button>`
              : `<button class="btn btn-sm btn-success" onclick="handleStatusChange('${p.id}', 'inactive', 'sản phẩm')"><i class=\"fas fa-eye\"></i></button>`;
            const priceText =
              AdminJS && AdminJS.formatCurrency
                ? AdminJS.formatCurrency(p.price)
                : `${p.price.toLocaleString("vi-VN")} VNĐ`;

            return `
                    <tr data-type-id="${p.typeId}">
                        <td>${p.id}</td>
                        <!-- <td><img src="${p.image}" alt="${p.name}" class="product-thumbnail"></td> -->
                        <td>${p.name}</td>
                        <td>${typeName}</td>
                        <td>${priceText}</td>
                        <td>${p.stock}</td>
                        <td>${p.createdAt}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewProduct('${p.id}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" onclick="handleEdit('${p.id}', 'editProductForm', '/api/products')"><i class="fas fa-edit"></i></button>
                            ${toggleBtn}
                            <button class="btn btn-sm btn-danger" onclick="handleDelete('${p.id}', 'sản phẩm')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
          })
          .join("");

        // Cập nhật tổng
        const totalSpan = document.querySelector(".card-header .text-muted");
        if (totalSpan) {
          totalSpan.textContent = `Tổng: ${products.length} sản phẩm`;
        }
      }

      // Ghi đè loadCurrentPageData để trang này tự render
      function loadCurrentPageData() {
        renderProductTable();
        setupPagination(products.length, currentPage, itemsPerPage);
      }

      // Xem chi tiết sản phẩm từ mảng products
      function viewProduct(productId) {
        const p = products.find((x) => x.id === productId);
        if (!p) return;
        document.getElementById("viewProductName").textContent = p.name;
        document.getElementById("viewProductCode").textContent = p.id;
        document.getElementById("viewProductType").textContent =
          productTypeMap[p.typeId] || "";
        const priceText =
          AdminJS && AdminJS.formatCurrency
            ? AdminJS.formatCurrency(p.price)
            : `${p.price.toLocaleString("vi-VN")} VNĐ`;
        document.getElementById("viewProductPrice").textContent = priceText;
        document.getElementById("viewProductStock").textContent = String(
          p.stock
        );
        document.getElementById("viewProductStatus").textContent =
          p.status === "active" ? "Hiển thị" : "Đã ẩn";
        document.getElementById("viewProductDescription").textContent =
          p.description || "";
        document.getElementById("viewProductImage").src = p.image || "";
        openModal("viewProductModal");
      }

      // Ghi đè handler để cập nhật DOM ngay
      window.handleEdit = function (id, formId, apiEndpoint) {
        const modal = document.getElementById("editProductModal");
        const data = products.find((p) => p.id === id);
        if (!modal || !data) return;
        document.getElementById("editProductId").value = data.id;
        document.getElementById("editProductCode").value = data.id;
        document.getElementById("editProductType").value = data.typeId;
        document.getElementById("editProductName").value = data.name;
        document.getElementById("editProductDescription").value =
          data.description || "";
        document.getElementById("editProductPrice").value = data.price;
        document.getElementById("editProductStock").value = data.stock;
        document.getElementById("editProductStatus").value = data.status;
        openModal("editProductModal");
      };

      window.handleDelete = function (id, itemName) {
        if (!confirm("Bạn có chắc chắn muốn xóa " + itemName + " này?")) return;
        const index = products.findIndex((p) => p.id === id);
        if (index !== -1) {
          products.splice(index, 1);
          showAlert("Xóa thành công!", "success");
          const maxPage = Math.max(
            1,
            Math.ceil(products.length / itemsPerPage)
          );
          if (currentPage > maxPage) currentPage = maxPage;
          loadCurrentPageData();
        }
      };

      window.handleStatusChange = function (id, currentStatus, itemName) {
        const item = products.find((p) => p.id === id);
        if (!item) return;
        const newStatus = currentStatus === "active" ? "inactive" : "active";
        const action = newStatus === "active" ? "kích hoạt" : "vô hiệu hóa";
        if (!confirm(`Bạn có chắc chắn muốn ${action} ${itemName} này?`))
          return;
        item.status = newStatus;
        showAlert(
          `${action.charAt(0).toUpperCase() + action.slice(1)} thành công!`,
          "success"
        );
        loadCurrentPageData();
      };

      // Ghi đè handleFilter để hỗ trợ lọc theo loại & trạng thái
      window.handleFilter = function (e) {
        const content = e.target.closest(".admin-content");
        const table = content
          ? content.querySelector(".admin-table tbody")
          : null;
        if (!table) return;
        const selects = content.querySelectorAll(
          ".search-filter-bar .filter-select"
        );
        let selectedType = "all";
        let selectedStatus = "all";
        if (selects[0]) selectedType = selects[0].value;
        if (selects[1]) selectedStatus = selects[1].value;

        const rows = table.querySelectorAll("tr");
        rows.forEach((row) => {
          const rowTypeId = row.getAttribute("data-type-id");
          const statusCell = row.querySelector(".status-badge");
          const statusText = statusCell
            ? statusCell.textContent.toLowerCase()
            : "";

          const passType = selectedType === "all" || rowTypeId === selectedType;
          const passStatus =
            selectedStatus === "all" || statusText.includes(selectedStatus);
          row.style.display = passType && passStatus ? "" : "none";
        });
      };

      // Submit form: Thêm
      document
        .getElementById("addProductForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const form = e.currentTarget;
          if (!validateForm(form)) return;
          const id = document.getElementById("productCode").value.trim();
          const typeId = document.getElementById("productType").value;
          const name = document.getElementById("productName").value.trim();
          const description = document
            .getElementById("productDescription")
            .value.trim();
          const price = Number(document.getElementById("productPrice").value);
          const stock = Number(document.getElementById("productStock").value);
          const status = document.getElementById("productStatus").checked
            ? "active"
            : "inactive";

          const submitBtn = form.querySelector('button[type="submit"]');
          const original = submitBtn.innerHTML;
          submitBtn.innerHTML = '<span class="loading"></span> Đang xử lý...';
          submitBtn.disabled = true;

          setTimeout(() => {
            products.unshift({
              id,
              name,
              typeId,
              price,
              stock,
              createdAt: new Date().toLocaleDateString("vi-VN"),
              status,
              image: "../client/assets/images/product-right.png",
              description,
            });
            showAlert("Thêm sản phẩm thành công!", "success");
            closeModal(document.getElementById("addProductModal"));
            form.reset();
            submitBtn.innerHTML = original;
            submitBtn.disabled = false;
            currentPage = 1;
            loadCurrentPageData();
          }, 600);
        });

      // Submit form: Cập nhật
      document
        .getElementById("editProductForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const form = e.currentTarget;
          if (!validateForm(form)) return;
          const id = document.getElementById("editProductId").value;
          const code = document.getElementById("editProductCode").value.trim();
          const typeId = document.getElementById("editProductType").value;
          const name = document.getElementById("editProductName").value.trim();
          const description = document
            .getElementById("editProductDescription")
            .value.trim();
          const price = Number(
            document.getElementById("editProductPrice").value
          );
          const stock = Number(
            document.getElementById("editProductStock").value
          );
          const status = document.getElementById("editProductStatus").value;

          const submitBtn = form.querySelector('button[type="submit"]');
          const original = submitBtn.innerHTML;
          submitBtn.innerHTML = '<span class="loading"></span> Đang xử lý...';
          submitBtn.disabled = true;

          setTimeout(() => {
            const idx = products.findIndex((p) => p.id === id);
            if (idx !== -1) {
              const current = products[idx];
              const newId = code || id;
              products[idx] = {
                ...current,
                id: newId,
                name,
                typeId,
                description,
                price,
                stock,
                status,
              };
            }
            showAlert("Cập nhật sản phẩm thành công!", "success");
            closeModal(document.getElementById("editProductModal"));
            submitBtn.innerHTML = original;
            submitBtn.disabled = false;
            loadCurrentPageData();
          }, 600);
        });

      // Khởi tạo
      document.addEventListener("DOMContentLoaded", function () {
        loadCurrentPageData();
      });
    </script>

    <style>
      .text-muted {
        color: #6c757d;
        font-size: 14px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #f1f3f4;
      }

      .form-text {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 14px;
      }

      .checkbox-label input[type="checkbox"] {
        margin-right: 8px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .product-thumbnail {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 8px;
      }

      .product-detail {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .product-detail-image {
        width: 100%;
        max-width: 300px;
        height: auto;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .product-info-section h4 {
        color: #072e75;
        margin-bottom: 15px;
        font-size: 20px;
      }

      .product-info-section p {
        margin-bottom: 10px;
        color: #666;
      }

      .product-code,
      .product-type,
      .product-price,
      .product-stock,
      .product-status {
        font-weight: 500;
      }

      .product-description {
        margin-top: 20px;
      }

      .product-description h5 {
        color: #072e75;
        margin-bottom: 10px;
      }

      .btn-info {
        background: #17a2b8;
        color: white;
      }

      .btn-info:hover {
        background: #138496;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }

        .product-detail {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </body>
</html>
