<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý khách hàng - Admin Panel</title>
    <link rel="stylesheet" href="assets/css/admin-style.css">
    <link rel="stylesheet" href="../client/assets/css/font.css">
    <link rel="icon" type="image/png" href="../client/assets/images/Logo.png">
    <link rel="stylesheet" href="assets/css/font.css">
</head>
<body>
    <!-- Admin Header -->
    <header class="admin-header">
        <div class="container">
            <div class="admin-logo">
                <img src="../client/assets/images/Logo.png" alt="Logo">
                <span>Admin Panel</span>
            </div>
            <div class="admin-user-info">
                <div class="user-avatar">A</div>
                <span>Admin User</span>
                <button class="logout-btn" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Đăng xuất
                </button>
            </div>
        </div>
    </header>

    <!-- Admin Layout -->
    <div class="admin-layout">
        <!-- Sidebar -->
        <nav class="admin-sidebar">
            <!-- Logo -->
            <div class="sidebar-logo">
                <div class="logo-text">
                    <div class="logo-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <span>AdminPanel</span>
                </div>
            </div>
            
            <!-- Menu -->
            <ul class="sidebar-menu">
                <div class="menu-section-title">Menu</div>
                <li>
                    <a href="dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="user-management.html" class="active">
                        <i class="fas fa-users"></i>
                        Quản lý khách hàng
                    </a>
                </li>
                <li>
                    <a href="product-type-management.html">
                        <i class="fas fa-tags"></i>
                        Quản lý loại sản phẩm
                    </a>
                </li>
                <li>
                    <a href="product-management.html">
                        <i class="fas fa-box"></i>
                        Quản lý sản phẩm
                    </a>
                </li>
                <li>
                    <a href="import-management.html">
                        <i class="fas fa-warehouse"></i>
                        Quản lý nhập hàng
                    </a>
                </li>
                <li>
                    <a href="price-management.html">
                        <i class="fas fa-dollar-sign"></i>
                        Quản lý giá bán
                    </a>
                </li>
                <li>
                    <a href="order-management.html">
                        <i class="fas fa-shopping-cart"></i>
                        Quản lý đơn hàng
                    </a>
                </li>
                <li>
                    <a href="inventory-management.html">
                        <i class="fas fa-clipboard-list"></i>
                        Quản lý tồn kho
                    </a>
                </li>
                <li>
                    <a href="#" onclick="handleLogout(); return false;">
                        <i class="fas fa-sign-out-alt"></i>
                        Đăng xuất
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-content">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title">Quản lý khách hàng</h1>
                    <p class="page-subtitle">Quản lý thông tin và trạng thái tài khoản khách hàng</p>
                </div>

                <!-- Search and Filter Bar -->
                <div class="search-filter-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Tìm kiếm khách hàng theo tên, email, số điện thoại...">
                    </div>
                    <select class="form-control filter-select">
                        <option value="all">Tất cả trạng thái</option>
                        <option value="active">Đang hoạt động</option>
                        <option value="inactive">Đã khóa</option>
                    </select>
                    <button class="btn btn-primary" data-modal="addUserModal">
                        <i class="fas fa-plus"></i>
                        Thêm khách hàng
                    </button>
                </div>

                <!-- Users Table -->
                <div class="admin-card">
                    <div class="card-header">
                        <h3 class="card-title">Danh sách khách hàng</h3>
                        <span class="text-muted">Tổng: 1,250 khách hàng</span>
                    </div>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th data-sort="0">ID</th>
                                    <th data-sort="1">Họ tên</th>
                                    <th data-sort="2">Email</th>
                                    <th data-sort="3">Số điện thoại</th>
                                    <th data-sort="4">Ngày đăng ký</th>
                                    <th data-sort="5">Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>KH001</td>
                                    <td>Nguyễn Văn An</td>
                                    <td>nguyenvanan@email.com</td>
                                    <td>0901234567</td>
                                    <td>15/11/2024</td>
                                    <td><span class="status-badge status-active">Hoạt động</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="handleEdit('KH001', 'editUserForm', '/api/users')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="resetPassword('KH001', 'Nguyễn Văn An')">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="handleStatusChange('KH001', 'active', 'khách hàng')">
                                            <i class="fas fa-lock"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>KH002</td>
                                    <td>Trần Thị Bình</td>
                                    <td>tranthibinh@email.com</td>
                                    <td>0912345678</td>
                                    <td>20/11/2024</td>
                                    <td><span class="status-badge status-active">Hoạt động</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="handleEdit('KH002', 'editUserForm', '/api/users')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="resetPassword('KH002', 'Trần Thị Bình')">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="handleStatusChange('KH002', 'active', 'khách hàng')">
                                            <i class="fas fa-lock"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>KH003</td>
                                    <td>Lê Văn Cường</td>
                                    <td>levancuong@email.com</td>
                                    <td>0923456789</td>
                                    <td>25/11/2024</td>
                                    <td><span class="status-badge status-inactive">Đã khóa</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="handleEdit('KH003', 'editUserForm', '/api/users')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="resetPassword('KH003', 'Lê Văn Cường')">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="handleStatusChange('KH003', 'inactive', 'khách hàng')">
                                            <i class="fas fa-unlock"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>KH004</td>
                                    <td>Phạm Thị Dung</td>
                                    <td>phamthidung@email.com</td>
                                    <td>0934567890</td>
                                    <td>01/12/2024</td>
                                    <td><span class="status-badge status-active">Hoạt động</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="handleEdit('KH004', 'editUserForm', '/api/users')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="resetPassword('KH004', 'Phạm Thị Dung')">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="handleStatusChange('KH004', 'active', 'khách hàng')">
                                            <i class="fas fa-lock"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>KH005</td>
                                    <td>Hoàng Văn Em</td>
                                    <td>hoangvanem@email.com</td>
                                    <td>0945678901</td>
                                    <td>05/12/2024</td>
                                    <td><span class="status-badge status-active">Hoạt động</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="handleEdit('KH005', 'editUserForm', '/api/users')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="resetPassword('KH005', 'Hoàng Văn Em')">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="handleStatusChange('KH005', 'active', 'khách hàng')">
                                            <i class="fas fa-lock"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Thêm khách hàng mới</h3>
                <button class="close">&times;</button>
            </div>
            <form id="addUserForm">
                <div class="form-group">
                    <label for="fullName" class="form-label">Họ và tên *</label>
                    <input type="text" id="fullName" name="fullName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="email" class="form-label">Email *</label>
                    <input type="email" id="email" name="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="phone" class="form-label">Số điện thoại *</label>
                    <input type="tel" id="phone" name="phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="address" class="form-label">Địa chỉ</label>
                    <textarea id="address" name="address" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="password" class="form-label">Mật khẩu mặc định *</label>
                    <input type="password" id="password" name="password" class="form-control" value="123456" required>
                    <small class="form-text text-muted">Mật khẩu mặc định: 123456 (khách hàng có thể đổi sau)</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="sendEmail" name="sendEmail" checked>
                        <span class="checkmark"></span>
                        Gửi thông tin đăng nhập qua email
                    </label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal(document.getElementById('addUserModal'))">
                        Hủy
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Thêm khách hàng
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Chỉnh sửa thông tin khách hàng</h3>
                <button class="close">&times;</button>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserId" name="userId">
                <div class="form-group">
                    <label for="editFullName" class="form-label">Họ và tên *</label>
                    <input type="text" id="editFullName" name="fullName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editEmail" class="form-label">Email *</label>
                    <input type="email" id="editEmail" name="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editPhone" class="form-label">Số điện thoại *</label>
                    <input type="tel" id="editPhone" name="phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editAddress" class="form-label">Địa chỉ</label>
                    <textarea id="editAddress" name="address" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editStatus" class="form-label">Trạng thái</label>
                    <select id="editStatus" name="status" class="form-control">
                        <option value="active">Hoạt động</option>
                        <option value="inactive">Đã khóa</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal(document.getElementById('editUserModal'))">
                        Hủy
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Cập nhật
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="assets/js/admin.js"></script>
    <script>
        // Dữ liệu mock khách hàng
        const users = [
            { id: 'KH001', fullName: 'Nguyễn Văn An', email: 'nguyenvanan@email.com', phone: '0901234567', createdAt: '15/11/2024', status: 'active', address: 'Hà Nội' },
            { id: 'KH002', fullName: 'Trần Thị Bình', email: 'tranthibinh@email.com', phone: '0912345678', createdAt: '20/11/2024', status: 'active', address: 'Hồ Chí Minh' },
            { id: 'KH003', fullName: 'Lê Văn Cường', email: 'levancuong@email.com', phone: '0923456789', createdAt: '25/11/2024', status: 'inactive', address: 'Đà Nẵng' },
            { id: 'KH004', fullName: 'Phạm Thị Dung', email: 'phamthidung@email.com', phone: '0934567890', createdAt: '01/12/2024', status: 'active', address: 'Cần Thơ' },
            { id: 'KH005', fullName: 'Hoàng Văn Em', email: 'hoangvanem@email.com', phone: '0945678901', createdAt: '05/12/2024', status: 'active', address: 'Hải Phòng' }
        ];

        function generateNewUserId() {
            const nums = users.map(u => parseInt(u.id.replace('KH', ''), 10));
            const next = (Math.max(...nums, 0) + 1).toString().padStart(3, '0');
            return `KH${next}`;
        }

        function renderUserTable() {
            const tbody = document.querySelector('.admin-table tbody');
            if (!tbody) return;
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = users.slice(start, end);

            tbody.innerHTML = pageItems.map(u => {
                const isActive = u.status === 'active';
                const statusBadge = isActive
                    ? '<span class="status-badge status-active">Hoạt động</span>'
                    : '<span class="status-badge status-inactive">Đã khóa</span>';
                const toggleBtn = isActive
                    ? `<button class=\"btn btn-sm btn-danger\" onclick=\"handleStatusChange('${u.id}', 'active', 'khách hàng')\"><i class=\"fas fa-lock\"></i></button>`
                    : `<button class=\"btn btn-sm btn-success\" onclick=\"handleStatusChange('${u.id}', 'inactive', 'khách hàng')\"><i class=\"fas fa-unlock\"></i></button>`;

                return `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.fullName}</td>
                        <td>${u.email}</td>
                        <td>${u.phone}</td>
                        <td>${u.createdAt}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="handleEdit('${u.id}', 'editUserForm', '/api/users')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-secondary" onclick="resetPassword('${u.id}', '${u.fullName}')"><i class="fas fa-key"></i></button>
                            ${toggleBtn}
                            <button class="btn btn-sm btn-danger" onclick="handleDelete('${u.id}', 'khách hàng')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            const totalSpan = document.querySelector('.card-header .text-muted');
            if (totalSpan) {
                totalSpan.textContent = `Tổng: ${users.length} khách hàng`;
            }
        }

        // Ghi đè loadCurrentPageData
        function loadCurrentPageData() {
            renderUserTable();
            setupPagination(users.length, currentPage, itemsPerPage);
        }

        // Ghi đè handler
        window.handleEdit = function(id, formId, apiEndpoint) {
            const modal = document.getElementById('editUserModal');
            const u = users.find(x => x.id === id);
            if (!modal || !u) return;
            document.getElementById('editUserId').value = u.id;
            document.getElementById('editFullName').value = u.fullName;
            document.getElementById('editEmail').value = u.email;
            document.getElementById('editPhone').value = u.phone;
            document.getElementById('editAddress').value = u.address || '';
            document.getElementById('editStatus').value = u.status;
            openModal('editUserModal');
        };

        window.handleDelete = function(id, itemName) {
            if (!confirm('Bạn có chắc chắn muốn xóa ' + itemName + ' này?')) return;
            const index = users.findIndex(u => u.id === id);
            if (index !== -1) {
                users.splice(index, 1);
                showAlert('Xóa thành công!', 'success');
                const maxPage = Math.max(1, Math.ceil(users.length / itemsPerPage));
                if (currentPage > maxPage) currentPage = maxPage;
                loadCurrentPageData();
            }
        };

        window.handleStatusChange = function(id, currentStatus, itemName) {
            const u = users.find(x => x.id === id);
            if (!u) return;
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'kích hoạt' : 'khóa';
            if (!confirm(`Bạn có chắc chắn muốn ${action} ${itemName} này?`)) return;
            u.status = newStatus;
            showAlert(`${action.charAt(0).toUpperCase() + action.slice(1)} thành công!`, 'success');
            loadCurrentPageData();
        };

        // Ghi đè handleFilter để dùng class badge thay vì text
        window.handleFilter = function(e) {
            const filterValue = e.target.value; // all | active | inactive
            const table = e.target.closest('.admin-content').querySelector('.admin-table tbody');
            if (!table) return;
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                if (filterValue === 'all') {
                    row.style.display = '';
                } else {
                    const badge = row.querySelector('.status-badge');
                    const isActive = badge && badge.classList.contains('status-active');
                    const match = (filterValue === 'active' && isActive) || (filterValue === 'inactive' && !isActive);
                    row.style.display = match ? '' : 'none';
                }
            });
        };

        // Reset mật khẩu (giữ nguyên mô phỏng)
        function resetPassword(userId, userName) {
            if (confirm(`Bạn có chắc chắn muốn reset mật khẩu cho khách hàng ${userName}?`)) {
                showAlert('Đang reset mật khẩu...', 'info');
                setTimeout(() => {
                    showAlert('Reset mật khẩu thành công! Mật khẩu mới: 123456', 'success');
                }, 800);
            }
        }

        // Submit: Thêm khách hàng
        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.currentTarget;
            if (!validateForm(form)) return;
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const password = document.getElementById('password').value; // không dùng nhưng giữ để hợp lệ

            const submitBtn = form.querySelector('button[type="submit"]');
            const original = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading"></span> Đang xử lý...';
            submitBtn.disabled = true;

            setTimeout(() => {
                users.unshift({ id: generateNewUserId(), fullName, email, phone, address, createdAt: new Date().toLocaleDateString('vi-VN'), status: 'active' });
                showAlert('Thêm khách hàng thành công!', 'success');
                closeModal(document.getElementById('addUserModal'));
                form.reset();
                submitBtn.innerHTML = original;
                submitBtn.disabled = false;
                currentPage = 1;
                loadCurrentPageData();
            }, 600);
        });

        // Submit: Cập nhật khách hàng
        document.getElementById('editUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.currentTarget;
            if (!validateForm(form)) return;
            const id = document.getElementById('editUserId').value;
            const fullName = document.getElementById('editFullName').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const address = document.getElementById('editAddress').value.trim();
            const status = document.getElementById('editStatus').value;

            const submitBtn = form.querySelector('button[type="submit"]');
            const original = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading"></span> Đang xử lý...';
            submitBtn.disabled = true;

            setTimeout(() => {
                const idx = users.findIndex(u => u.id === id);
                if (idx !== -1) {
                    users[idx] = { ...users[idx], fullName, email, phone, address, status };
                }
                showAlert('Cập nhật khách hàng thành công!', 'success');
                closeModal(document.getElementById('editUserModal'));
                submitBtn.innerHTML = original;
                submitBtn.disabled = false;
                loadCurrentPageData();
            }, 600);
        });

        // Khởi tạo
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentPageData();
        });
    </script>
    
    <style>
        .text-muted {
            color: #6c757d;
            font-size: 14px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f1f3f4;
        }
        
        .form-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
        }
    </style>
</body>
</html>
